<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Questions Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Custom background gradient for the card */
        .card-bg {
            background: linear-gradient(135deg, #1f2937, #374151); /* Dark blue/gray gradient */
        }
        /* Style for the question text for readability */
        #question-display {
            min-height: 120px; /* Ensure space even with short questions */
        }
    </style>
</head>
<body>

    <!-- ============================================= -->
    <!-- APPLICATION LOGIC AND FIREBASE SETUP -->
    <!-- ============================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let isAuthReady = false;
        
        // Path to the public, shared question data
        const QUESTION_COLLECTION_PATH = `/artifacts/${appId}/public/data/questions`;

        // This will hold the real-time data from Firestore
        window.questionData = {}; 

        // --- DOM Elements ---
        const categorySelect = document.getElementById('category-select');
        const questionText = document.getElementById('question-text');
        const nextButton = document.getElementById('next-button');
        const loadingStatus = document.getElementById('loading-status');


        // State for the generator
        let currentCategory = '';
        let availableQuestions = [];

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                loadingStatus.textContent = "Error: Firebase configuration missing.";
                return;
            }

            try {
                // setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in using the custom token or anonymously
                await setPersistence(auth, browserLocalPersistence);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Listener for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        console.log("Firebase Auth Ready.");
                        // Start listening for real-time data
                        listenForQuestionData();
                    } else {
                        console.log("No user signed in.");
                        isAuthReady = true;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                loadingStatus.textContent = `Error during initialization: ${error.message}`;
            }
        }

        /**
         * Sets up real-time listener for the public question data.
         */
        function listenForQuestionData() {
            if (!db) return;

            const q = collection(db, QUESTION_COLLECTION_PATH);

            onSnapshot(q, (snapshot) => {
                const newData = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Each document ID is the category name, and it contains a 'questions' array
                    // Filter out empty categories
                    if (data.questions && data.questions.length > 0) {
                        newData[doc.id] = data.questions;
                    }
                });
                
                window.questionData = newData;
                console.log("Question data updated from Firestore.", newData);
                
                // Refresh UI components
                populateCategories();
                
                if (currentCategory && questionData[currentCategory]) {
                    categorySelect.value = currentCategory;
                    selectCategory(currentCategory, false);
                } else {
                    loadingStatus.classList.add('hidden');
                    questionText.textContent = "Select a category and press the button to start!";
                    nextButton.disabled = true;
                }

            }, (error) => {
                console.error("Error listening to Firestore data:", error);
                loadingStatus.textContent = `Data fetch error: ${error.message}`;
            });
        }

        // --- Question Generator Functions ---

        /**
         * Populates the category dropdown with options.
         */
        function populateCategories() {
            const categories = Object.keys(window.questionData).sort();
            
            categorySelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = categories.length > 0 ? '--- Choose a Category ---' : '--- No Questions Available ---';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            categorySelect.appendChild(defaultOption);

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        /**
         * Updates the current category and loads the corresponding questions.
         */
        function selectCategory(categoryName, resetQuestion = true) {
            currentCategory = categoryName;
            availableQuestions = window.questionData[categoryName] || [];
            
            if (availableQuestions.length > 0) {
                nextButton.disabled = false;
                if (resetQuestion) {
                    displayRandomQuestion();
                }
            } else {
                questionText.textContent = "No questions found for this category. Please select another.";
                nextButton.disabled = true;
            }
        }

        /**
         * Selects and displays a random question from the current category's list.
         */
        function displayRandomQuestion() {
            if (availableQuestions.length === 0) {
                questionText.textContent = "Please select a category first!";
                nextButton.disabled = true;
                return;
            }

            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const question = availableQuestions[randomIndex];

            // Simple transition effect for the text
            questionText.classList.remove('opacity-100');
            questionText.classList.add('opacity-0');

            setTimeout(() => {
                questionText.textContent = question;
                questionText.classList.remove('opacity-0');
                questionText.classList.add('opacity-100');
            }, 100);
        }

        // --- Initialization and Event Listeners ---

        window.onload = function() {
            initializeFirebase();
            
            // Initial view setup
            nextButton.disabled = true;

            // Generator Event Listeners
            categorySelect.addEventListener('change', (event) => selectCategory(event.target.value));
            nextButton.addEventListener('click', displayRandomQuestion);
        };
    </script>

    <div id="app" class="w-full max-w-lg mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- === Generator View === -->
        <div id="generator-view" class="view">
            <div class="card-bg p-8 rounded-2xl shadow-2xl text-white">
                
                <header class="mb-6 text-center">
                    <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Emergency Questions</h1>
                    <p class="text-gray-300 mt-2 text-sm sm:text-base">Break the ice. Spark a conversation.</p>
                </header>
                
                <!-- Loading Status -->
                <p id="loading-status" class="text-center text-sm text-yellow-500 mb-4">Database initializing...</p>

                <!-- Category Selector Dropdown -->
                <div class="mb-6">
                    <label for="category-select" class="block text-sm font-medium mb-2 text-gray-200">Select Category:</label>
                    <select id="category-select" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500 cursor-pointer shadow-inner transition duration-150">
                        <option value="">--- Loading Categories ---</option>
                    </select>
                </div>

                <!-- Question Display Area -->
                <div id="question-display" class="bg-gray-800 p-6 rounded-xl shadow-inner mb-8 flex items-center justify-center text-center">
                    <p id="question-text" class="text-xl sm:text-2xl font-semibold text-yellow-300 transition duration-300 ease-in-out">
                        Waiting for data...
                    </p>
                </div>

                <!-- Action Button -->
                <button id="next-button" 
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg 
                            transform transition duration-150 hover:scale-[1.03] active:scale-95 
                            focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50"
                        disabled>
                    Next Question
                </button>
            </div>
        </div>
        
    </div>
</body>
</html>
